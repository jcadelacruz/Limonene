<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>replit</title>
</head>

  <body style="position: fixed; font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; font-size: xx-large;
    color: darkslategray; background-color: lightskyblue;
    " id="body">
    <h1 id="hi">MOUSEBOT</h1>
    <p style="text-align: center;">
      X: <span id="x_coordinate"> </span>
      Y: <span id="y_coordinate"> </span>
      Speed: <span id="speed"> </span>
      Angle: <span id="angle"> </span>
    </p>
    <div id="UI">
      <button id="moveBtnA" class="moveBtn UI">A</button>
      <button id="moveBtnB" class="moveBtn UI">B</button>
      <div id="joystick" class="UI"></div>
    </div>
    </body>
<!---------------------------------------------->
  <style>
    /* Disable text selection for the entire page */
    body {
        user-select: none; -moz-user-select: none; -webkit-user-select: none; -ms-user-select: none;
    }
    /* Enable text selection for specific elements if needed */
    .allow-select {
        user-select: text; -moz-user-select: text; -webkit-user-select: text; -ms-user-select: text;
    }
    h1{
      text-align:center;
    }
    .UI, #UI>*{
      z-index: 100;
      position: fixed;
      opacity: 0.7;
    }
    #pauseDiv>*{
      background-color: green;
      width: 100px;
      height: 100px;
      opacity: 0.9;
      margin: 30px;
    }
    .moveBtn{
      width: 100px; height: 100px;
      border-radius: 100%;
      margin: 10px;
    }
    #moveBtnA{ bottom: 0; right: 100px;}
    #moveBtnB{ bottom: 100px; right: 0;}
    #joystick{
      background-color: lightgreen;
      border-radius: 100%;
      
      bottom: 0; left: 0;
    }
    #joystick > *{
      background-color: lightgreen;
      border-radius: 100%;
    }
  </style>
<!---------------------------------------------->
  <script>
  //WINDOW functions
    var FRAMERATE = 0.5, timer;
    const UI_ZINDEX = 100, PAUSE_ZINDEX = UI_ZINDEX + 1, BG_ZINDEX = 1, ENTITY_ZINDEX = 5, MSG_ZINDEX = 40;//Play area z index should be below 50 
    window.addEventListener('load', () => {
      document.addEventListener('touchmove', function(event) {if (event.touches.length > 1) { event.preventDefault();}}, { passive: false });// Disable pinch zoom on the document
      
      resize(); 
      window.addEventListener('resize', resize);
        //update
      startTimer();
        //UI
      initializeJoystickAndFunctions();
      initializeMoveButtons();
      initializeOtherUIButtons();
        //game instances
      initializeInstances();
    });
    function resize(){
      let width = window.innerWidth; let height = window.innerHeight;
      resizeTo(width, height);
    }
    function startTimer(){ timer = setInterval(update, 1000/FRAMERATE);}
    //GENERAL functions
      function update(){
        currentRoom.display();
        currentRoom.updatePopulation();
      }

  //GAME INSTANCES
      //WEAPONS
    class Weapon{
      constructor(d, r, k, pK, s, m, w, rR, bC){
        this.damage = d; this.range = r; this.knockback = k; this.playerKnockback = pK; this.spread = s; this.magicEffect = m; this.weight = w; this.reloadRate = rR; this.bulletCount = bC;
        
      }
      executeWeaponFunction(){//TEST CONTENT
        kob();
        window.setTimeout(function() {bok();}, 500);
      }
    }
      //ROOM
    var roomList = [];
    var currentRoom;
    const roomSize = 1000;
    class Room{
      constructor(n, x, y, ex, ey){
        this.name = n;
        this.entityPopulation = null;
        this.exitX = ex; this.exitY = ey;
      }
      updatePopulation(){
        let l = this.entityPopulation.length;
        for(let i = 0; i < l; i++){
          this.entityPopulation[i].update();
          this.entityPopulation[i].display();
        }
      }
      initializePopulation(){
        let l = this.entityPopulation.length;
        for(let i = 0; i < l; i++){
          this.entityPopulation[i].inGame = true;
        }
      }
      display(){
        console.log("in room: "+this.name);
      }
    }
      //ENTITY
    var player;
    const sightRange = 70, sightRangeSquared = sightRange*sightRange, attackRange = 20, attackRangeSquared = attackRange*attackRange;
    class Entity{
      constructor(h, s, sp, x, y){
        //attack
        this.maxHP = h;
        this.hp = h;
        this.str = s;
        //position
        this.speed = sp;
        this.inGame = false;
        this.x = x; this.y = y;
        this.moveAngle = null;
        this.trackingPlayer = false;
      }
      move(){
        let x = this.x + Math.cos(this.moveAngle) * this.speed;
        let y = this.y + Math.sin(this.moveAngle) * this.speed;
        if(x<0||x>roomSize||y<0||y>roomSize) return;
        this.x = x; this.y = y;
      }
      update(turn){
        //pathfinding
        let px = player.x - this.x; let py = player.y - this.y;
        let d = (px*px)+(py*py);
        if( d<=sightRangeSquared){
          let m = Math.atan(py/px);
          this.moveAngle = (px<0) ? ((py<0)?m+Math.PI:Math.PI+m) : ((py<0)?(2*Math.PI)+m:m);
          this.trackingPlayer = true;
          if(d<=attackRangeSquared){
            this.attackPlayer();
            return;//to give player space ig?
          }
        }
        else{
          if(trackingPlayer===true){
            px = currentRoom.exitX - this.x; py = currentRoom.exitY - this.y;
            let m = Math.atan(py/px);
            this.moveAngle = (px<0) ? ((py<0)?m+Math.PI:Math.PI+m) : ((py<0)?(2*Math.PI)+m:m);
            this.trackingPlayer = false;
          }
        }
        //movement
        this.move();
      }
      display(){
        console.log("entity: "+this.hp+"/"+this.maxHP+" at ("+this.x+","+this.y+")");
      }
      attackPlayer(){
        
      }
    }
    class Player extends Entity{
      update(){
        this.move();
      }
    }

    function initializeInstances(){
      //weapons
      //room
      var r00 = new Room("home", 0,0, 0,0);
      var r01 = new Room("cross", 0,1, 500,1000);
      roomList = [r00, r01];
      //entities
      var e01_01 = new Entity(100, 10, 2, 0,0);
      r01.entityPopulation = [e01_01];
      
      player = new Player(100, 10, 4, 0,0);
      r00.entityPopulation = [player];
      currentRoom = r00;
      
      initializeAllPopulationsInRoomList();
    }
    function initializePlayer(){
    }
    function initializeAllPopulationsInRoomList(){
      let l = roomList.length;
      for(let i=0; i<l; i++){
        roomList[i].initializePopulation();
      }
    }
    
  //UI BUTTON functions
    var pauseBtn, pauseDiv;
    var settingsBtn, quitBtn;
    function initializeOtherUIButtons(){
      //PAUSE BUTTON
      pauseBtn = document.createElement('button');
      pauseBtn.id = "pauseBtn";
      pauseBtn.style = "width: 62px; height: 62px; border-color: black; border-width: 4px; margin: 20px; border-radius: 10%; background-color: lightgreen; position: fixed; top: 0; right: 0; z-index: "+PAUSE_ZINDEX+";";
      document.getElementById("UI").appendChild(pauseBtn);
        //functions
      pauseBtn.addEventListener('touchstart', pause);
      pauseBtn.addEventListener('mousedown' , pause);
      //PAUSED DIV
      pauseDiv = document.createElement('div'); pauseDiv.id = "pauseDiv";
      pauseDiv.style = "width: 100%; height: 100%; background-color: black; opacity: 50%; z-index: "+(PAUSE_ZINDEX-1)+"; position: fixed; top: 0; left: 0; display: flex; justify-content: center; align-items: center;";
      pauseDiv.style.visibility = "hidden";
      document.getElementById('body').appendChild(pauseDiv);
        //within div
      settingsBtn = document.createElement('button'); settingsBtn.id = "settingsBtn";
      settingsBtn.innerText = "Settings";
      quitBtn = document.createElement('button'); quitBtn.id = "quitBtn";
      quitBtn.innerText = "Quit";
          //functions
          //adding
      pauseDiv.appendChild(settingsBtn);
      pauseDiv.appendChild(quitBtn);
    }
    
    function pause(){
      clearInterval(timer);
      //make all pause elements visible
      pauseDiv.style.visibility = "visible";
      //make pauseBtn to unpause
      pauseBtn.removeEventListener('touchstart', pause);
      pauseBtn.removeEventListener('mousedown' , pause);
      pauseBtn.addEventListener('touchstart', unpause);
      pauseBtn.addEventListener('mousedown' , unpause);
    }
    function unpause(){
      //remove all elements visibility
      pauseDiv.style.visibility = "hidden";
      //re set pause btn
      pauseBtn.removeEventListener('touchstart', unpause);
      pauseBtn.removeEventListener('mousedown' , unpause);
      pauseBtn.addEventListener('touchstart', pause);
      pauseBtn.addEventListener('mousedown' , pause);
      //timer start
      startTimer();
    }
  //MOVE BUTTON functions
    function initializeMoveButtons(){
      var moveBtnA = new MoveBtn(document.getElementById('moveBtnA'), "yellow");
      var moveBtnB = new MoveBtn(document.getElementById('moveBtnB'), "blue");
      moveBtnA.setWeapon(new Weapon(1,2,3,4,5,6,7,8,9));//test
      //moveBtnB.setWeapon(new Weapon(1,2,3,4,5,6,7,8,9));//test
    }
    class MoveBtn{
      constructor(buttonElement, color){
        this.htmlElement = buttonElement;
        this.htmlElement.addEventListener('touchstart', unequippedWeaponFunction);
        this.htmlElement.addEventListener('mousedown' , unequippedWeaponFunction);
        this.color = color;
        this.htmlElement.style.backgroundColor = color;

        this.weapon = null;
      }
      setWeapon(weapon){
        this.weapon = weapon;
        this.htmlElement.removeEventListener('touchstart', unequippedWeaponFunction);
        this.htmlElement.removeEventListener('mousedown' , unequippedWeaponFunction);
        this.htmlElement.addEventListener('touchstart', weapon.executeWeaponFunction);
        this.htmlElement.addEventListener('mousedown' , weapon.executeWeaponFunction);
      }
    }
    function unequippedWeaponFunction(){
      console.log("button has no equipped weapon");
    }
    function kob(){
      document.getElementById("body").style.backgroundColor = "blue";
    }
    function bok(){
      document.getElementById("body").style.backgroundColor = "yellow";
    }

    function btnAFunction(){
      document.getElementById("body").style.backgroundColor = "blue";
    }
    function btnBFunction(){
      document.getElementById("body").style.backgroundColor = "orange";
    }

  //JOYSTICK functions
    var joystick = document.getElementById('joystick'), joystickMovable;
    const INITIALRADIUS = 60, INITIALMARGIN = 40;
    var radius = INITIALRADIUS, posX = 0, posY = 0, spd = 0, angl = 0;
    var joystickClicked = false;

    function initializeJoystickAndFunctions(){
      //making joystick + css
      makeJoystick();
      joystick.style.margin = INITIALMARGIN+"px";
      
      //mouse controls
      joystick.addEventListener('mousedown', startJoystick);
      window.addEventListener('mouseup', stopJoystick);
      window.addEventListener('mouseleave', stopJoystick);
      window.addEventListener('mousemove', moveJoystick);
      //touch controls
      joystick.addEventListener('touchstart', startJoystick);
      joystick.addEventListener('touchend', stopJoystick);
      //joystick.addEventListener('touchcancel', stopJoystick);
      body.addEventListener('touchmove', moveJoystick);
      //TEST display buttons
      document.getElementById("x_coordinate").innerText = 0;
      document.getElementById("y_coordinate").innerText = 0;
      document.getElementById("speed").innerText = 0;
      document.getElementById("angle").innerText = 0;
    }
      //computing css changes
    function makeJoystick() {
      joystick.style.width = radius*2+"px";
      joystick.style.height = radius*2+"px";
      joystick.style.backgroundColor = "red";
    }
    function makeJoystickMovable() {
      joystickMovable.style.width = INITIALRADIUS*2+"px";
      joystickMovable.style.height = INITIALRADIUS*2+"px";
      joystickMovable.style.backgroundColor = "red";
      joystickMovable.style.position = "fixed";
    }
    function changeRadius(int){
      joystick.style.margin =  parseInt(window.getComputedStyle(joystick).margin, 10) - (int-radius) + "px";
      radius = int;
    }
      //computing changes to variables
    function updatePos(e){
      //pos
      if(e.type == 'touchstart' || e.type == 'touchmove' || e.type == 'touchend' || e.type == 'touchcancel'){
        posX = e.touches[0].clientX;
        posY = e.touches[0].clientY;
      } else if (e.type == 'mousedown' || e.type == 'mouseup' || e.type == 'mousemove' || e.type == 'mouseover'|| e.type=='mouseout' || e.type=='mouseenter' || e.type=='mouseleave') {
        posX = e.clientX;
        posY = e.clientY;
      }
      var marginVal = parseInt(window.getComputedStyle(joystick).margin, 10);
      posY = window.innerHeight - posY - radius - marginVal;
      posX -= marginVal + radius;
      //speed
      spd = Math.sqrt((posX*posX) + (posY*posY)) / radius;
      checkIfWithinRadius();
        //finalize spd
        spd = Math.round(spd*100)/100;
      //angle
      angl = Math.atan(posY/posX);
      angl = (posX<0) ? ((posY<0)?angl+Math.PI:Math.PI+angl) : ((posY<0)?(2*Math.PI)+angl:angl);
        //convert to degrees if u want
      angl *= (180)/Math.PI;
    }
    function checkIfWithinRadius(){
      if(spd>1){
        posX /= spd; posY /= spd;
        spd = 1;
      }
    }
    /*function isItWithinRadius() {
      var distance = (posX*posX) + (posY*posY);
      if ( distance < radius*radius ) return true;
      else return false;
    }*/
    //event functions
    function startJoystick(event) {
      //make movable part of joystick in html
      joystickMovable = document.createElement('div');
      makeJoystickMovable();
      joystick.appendChild(joystickMovable);
      //start the joystick
      joystickClicked = true;
      changeRadius(85);
      makeJoystick();
      joystick.style.backgroundColor = "lightgreen";
      //update
      moveJoystick(event);
    }
    function stopJoystick() {
      //delete movable part of joystick in html
      joystick.innerText = "";
      //stop the joystick
      joystickClicked = false;
      changeRadius(60);
      makeJoystick();
      joystick.style.backgroundColor = "red";
      //reset stats
      resetStats();
      displayStats();
    }
    function moveJoystick(event) {
      if (joystickClicked){
        //update position
        updatePos(event);
        displayStats();
        //move joystickMovable
        moveJoystickMovable();
      }
    }
    //moving joystick movable
    function moveJoystickMovable(){
      var marginVal = parseInt(window.getComputedStyle(joystick).margin, 10);
      joystickMovable.style.left = marginVal + radius - INITIALRADIUS + posX + "px";
      joystickMovable.style.bottom = marginVal + radius - INITIALRADIUS + posY + "px";
    }
    //display functions
    function displayStats(){
      x_coordinate.innerText = Math.floor(posX);
      y_coordinate.innerText = Math.floor(posY);
      speed.innerText = spd;
      angle.innerText = Math.floor(angl*100)/100;
    }
    function resetStats(){
      posX=0; posY=0; spd=0; angl=0;
    }
  </script>

</html>