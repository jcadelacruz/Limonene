<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Limonene_replit</title>
</head>

  <body style="position: fixed; font-family: 'Lucida Console', 'Courier New','Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; text-align: left; font-weight: bolder;
    color: darkslategray; background-color: lightslategray;
    " id="body">
    <p style="font-size: 20px; white-space: pre;">
X:<span id="x_coordinate"></span><span id="e1"></span>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Sem et tortor consequat id porta nibh venenatis. Etiam dignissim diam quis enim. Pellentesque id nibh tortor id. Quis imperdiet massa tincidunt nunc pulvinar sapien et. Nunc faucibus a pellentesque sit amet porttitor.
Y:<span id="y_coordinate"></span><span id="e2"></span>Quis viverra nibh cras pulvinar mattis nunc sed blandit. Velit scelerisque in dictum non consectetur a erat nam. Nibh cras pulvinar mattis nunc sed blandit libero volutpat sed. Nisl pretium fusce id velit ut. Orci ac auctor augue mauris. Dui vivamus arcu felis bibendum ut tristique et. Elit ullamcorper dignissim cras tincidunt lobortis feugiat.
Speed:<span id="speed"></span><span id="e3"></span>Viverra aliquet eget sit amet tellus cras adipiscing enim. Volutpat sed cras ornare arcu. Fringilla ut morbi tincidunt augue interdum. Pulvinar etiam non quam lacus suspendisse faucibus. Quisque egestas diam in arcu. Sed nisi lacus sed viverra tellus.
Angle:<span id="angle"></span><span id="e4"></span>Sit amet consectetur adipiscing elit pellentesque habitant morbi tristique senectus. Et malesuada fames ac turpis egestas maecenas. Vitae suscipit tellus mauris a diam maecenas sed. Magna eget est lorem ipsum dolor sit amet consectetur adipiscing.
    </p>
    <div id="playArea"></div>
    <div id="UI">
      <button id="moveBtnA" class="moveBtn UI">A</button>
      <button id="moveBtnB" class="moveBtn UI">B</button>
      <div id="joystick" class="UI"></div>
    </div>
    </body>
<!---------------------------------------------->
  <style>
    html, body{ overscroll-behavior-y: contain;}
    /* Disable text selection for the entire page */
    body {
        user-select: none; -moz-user-select: none; -webkit-user-select: none; -ms-user-select: none;
    }
    /* Enable text selection for specific elements if needed */
    .allow-select {
        user-select: text; -moz-user-select: text; -webkit-user-select: text; -ms-user-select: text;
    }
    h1{
      text-align:center;
    }
    .room{
      background-color: royalblue;
      z-index: 1;
    }
    .room>div{
      background-color: darkviolet;
      z-index: 5;
      position: absolute;
    }
    #playArea{
      position: absolute;
      top: 0; left: 0;
    }
    .UI, #UI>*{
      z-index: 100;
      position: fixed;
      opacity: 0.7;
    }
    #pauseDiv>*{
      background-color: green;
      width: 100px;
      height: 100px;
      opacity: 0.9;
      margin: 30px;
    }
    .moveBtn{
      width: 100px; height: 100px;
      border-radius: 100%;
      margin: 10px;
    }
    #moveBtnA{ bottom: 0; right: 100px;}
    #moveBtnB{ bottom: 100px; right: 0;}
    #joystick{
      background-color: lightgreen;
      border-radius: 100%;
      
      bottom: 0; left: 0;
    }
    #joystick > *{
      background-color: lightgreen;
      border-radius: 100%;
    }
  </style>
<!---------------------------------------------->
  <script>
  //WINDOW functions
    
    var FRAMERATE = 24, timer, screenWidth = window.innerWidth, screenHeight = window.innerHeight;
    const UI_ZINDEX = 100, PAUSE_ZINDEX = UI_ZINDEX + 1, BG_ZINDEX = 1, ENTITY_ZINDEX = 5, MSG_ZINDEX = 40;//Play area z index should be below 50 
    window.addEventListener('load', () => {
      document.addEventListener('touchmove', function(event) {if (event.touches.length > 1) { event.preventDefault();}}, { passive: false });// Disable pinch zoom on the document
        //display stuff
      resize(); 
      window.addEventListener('resize', resize);
      window.addEventListener('deviceorientation', resize);
      displayStats();
        //update
      startTimer();
        //UI
      initializeJoystickAndFunctions();
      initializeMoveButtons();
      initializeOtherUIButtons();
        //game instances
      initializeInstances();
    });
    function resize(){
      screenWidth = window.innerWidth; screenHeight = window.innerHeight;
      resizeTo(screenWidth, screenHeight);
    }
    function startTimer(){ timer = setInterval(update, 1000/FRAMERATE);}
    //GENERAL functions
    let dturn = 0;
      function update(){
        currentRoom.display();
        currentRoom.updatePopulation();
      }

  //GAME INSTANCES
    function initializeInstances(){
      //weapons
      //room
      var r00 = new Room("home", 0,0, roomSize/2,0);
      var r01 = new Room("cross", 0,1, roomSize/2,0);
      var r11 = new Room("kitchen", 1,1, 0,roomSize/2);
      var rn11 = new Room("badlands", -1,1, roomSize,roomSize/2);
      var r02 = new Room("heaven", 0,2, roomSize/2,0);
      roomList = [r00, r01, r11, rn11, r02];
      //entities
      var e01_01 = new Entity(100, 10, 2, 0,2*roomSize/5);
      var e01_02 = new Entity(100, 10, 2, 20,2*roomSize/5);
      var e01_03 = new Entity(100, 10, 2, 30,2*roomSize/5);
      var e01_04 = new Entity(100, 10, 2, 40,2*roomSize/5);
      var e01_11 = new Entity(100, 10, 2, 0,roomSize/5);
      var e01_12 = new Entity(100, 10, 2, 20,roomSize/5);
      var e01_13 = new Entity(100, 10, 2, 30,roomSize/5);
      var e01_14 = new Entity(100, 10, 2, 40,roomSize/5);
      var e01_21 = new Entity(100, 10, 2, 0,3*roomSize/5);
      var e01_22 = new Entity(100, 10, 2, 20,3*roomSize/5);
      var e01_23 = new Entity(100, 10, 2, 30,3*roomSize/5);
      var e01_24 = new Entity(100, 10, 2, 40,3*roomSize/5);
      r01.entityPopulation = [];
        //player
      player = new Player(100, 10, 0, 0,0);
      r00.entityPopulation = [e01_02, e01_03]//, e01_04, e01_011, e01_012, e01_013, e01_014, e01_021, e01_022, e01_023, e01_024];
      r01.entityPopulation = [player, e01_01];
      currentRoom = r01;

      initializeAllPopulationsInRoomList();
      currentRoom.enter();
    }
    function initializePlayer(){}
    function initializeAllPopulationsInRoomList(){
      let l = roomList.length;
      for(let i=0; i<l; i++){
        roomList[i].initializePopulation();
      }
    }

      //WEAPONS
    class Bullet{
      constructor(w, s, sz, dir, x,y){
        this.weapon = w;
        this.speed = s; this.size = sz; this.direction = dir;
        this.x = x; this.y = y;
        
        let d = document.createElement('div');
          d.classList.add("bullet");
          d.style.width = sz+"px";d.style.height = sz+"px";
          d.style.backgroundColor = "white";
          d.style.borderRadius = "65%";
          d.style.rotate = dir+"rad";
        document.getElementById(currentRoom.name).appendChild(d);
        this.disp = d;
      }
      update(){
        this.move();
        this.executeEffect(this.collides());
        this.display();
      }
      move(){
        let x = this.x + Math.cos(this.direction) * this.speed;
        let y = this.y + Math.sin(this.direction) * this.speed;
        let s = this.size;
        if(x<=0) this.x = 0;
        else if(x+s>=roomSize) this.x = roomSize-s;
        else this.x = x;
        if(y<=0) this.y = 0;
        else if(y+s>=roomSize) this.y = roomSize-s;
        else this.y = y;
      }
      collides(){//pseudocode
        let col = false;
        let entity = "";
        if(1<2) return entity; 
        return col;
      }
      executeEffect(e){//pseudocode
        if(e===-1) return;
      }
      display(){
        this.disp.style.left = this.x + "px";
        this.disp.style.bottom = this.y + "px";
      }
    }
    class Weapon{
      constructor(bS,r,bSz,s,   bC,rR, a,   d, m,   k,   pK,w){
        this.bulletSpeed = bS; this.range = r; this.bulletSize = bSz, this.spread = s;//bullet movement identity
        this.bulletCount = bC; this.reloadRate = rR; this.ammo = a;//bullet use identity
        this.damage = d; this.magicEffect = m;//victim non-pos effect
        this.knockback = k;//victim pos effect
        this.playerKnockback = pK; this.weight = w;//shooter effects (active vs passive)

        this.bullets = [];
      }
      executeWeaponFunction(e){
        let aimDir = e.moveAngle;
        for(let i = 0; i < this.bulletCount; i++){
          let es2 = entitySize/2;
          let b = new Bullet(this, this.bulletSpeed, this.bulletSize, aimDir, e.x+(es2), e.y+(es2));
          this.bullets.push(b);
          aimDir += this.spread;
        }
      }
      unequip(){
        for(let i = 0; i < this.bullets.length; i++){
          this.bullets[i].disp.remove();
        }
        bullets = [];
      }
      update(){
        for(let i = 0; i < this.bullets.length; i++){
          this.bullets[i].update();
        }
      }
    }
      //ROOM
    var roomList = [];
    var currentRoom;
    const roomSize = 500;
    class Room{
      constructor(n, x, y, ex, ey){
        this.name = n;
        this.entityPopulation = [];
        this.exitX = ex; this.exitY = ey;
        this.x = x; this.y = y;
      }
      updatePopulation(){
        let l = this.entityPopulation.length;
        let r = currentRoom;
        for(let i = 0; i < l; i++){
          try{
            this.entityPopulation[i].update();
            this.entityPopulation[i].display();
          }
          catch(err){}
        }
      }
      initializePopulation(){
        let l = this.entityPopulation.length;
        for(let i = 0; i < l; i++){
          this.entityPopulation[i].inGame = true;
        }
      }
      initializeDisplay(){
        if(document.getElementById(this.name)!=null) return;
        let room = document.createElement('div');
        room.id = this.name;
        room.classList.add("room");
        room.style.width = roomSize + "px";
        room.style.height = roomSize + "px";
        room.style.position = "relative";
        let p =document.createElement('p');
        p.innerText = this.name;
        room.appendChild(p);
        document.getElementById('playArea').appendChild(room);

        let l = this.entityPopulation.length;
        for(let i = 0; i < l; i++){
          this.entityPopulation[i].initializeDisplay();
        }
      }
      display(){
        let c = document.getElementById(this.name);
        c.style.left = (screenWidth/2)-player.x +"px";
        c.style.top = (screenHeight/2)+player.y-roomSize +"px";
      }
      enter(){
        currentRoom = this;
        this.initializeDisplay();
      }
      entityTransfersTo(r, e){
        console.log("transfering to "+r.x+","+r.y);
        let originalArray = this.entityPopulation, newArray = r.entityPopulation;
        let indexToRemove = originalArray.indexOf(e);

        if (indexToRemove !== -1) {
            // Remove the element from the original array and add it to the new array
            newArray.push(originalArray.splice(indexToRemove, 1)[0]);

            console.log("Original Array:", originalArray);
            console.log("New Array:", newArray);
        } else {
            console.log("Element not found in the original array");
        }

        //remove display
        document.getElementById(currentRoom.name).removeChild(e.disp);
      }
      leave(){
        document.getElementById('playArea').removeChild(document.getElementById(this.name));
      }
    }
    function getRoom(x,y){
      let l = roomList.length;
      for(let i = 0; i<l; i++){
        if(roomList[i].x == x && roomList[i].y == y) return roomList[i];
      }
      return -1;
    }
      //ENTITY
    var player;
    const sightRange = 100, sightRangeSquared = sightRange*sightRange, attackRange = 30, attackRangeSquared = attackRange*attackRange, entitySize = 50;
    class Entity{
      constructor(h, s, sp, x, y){
        //attack
        this.maxHP = h;
        this.hp = h;
        this.str = s;
        //position
        this.speed = sp;
        this.inGame = false;
        this.x = x; this.y = y;
        this.moveAngle = 0;
        this.trackingPlayer = true;
        //display
        this.disp = null;
      }
      move(){
        let x = this.x + Math.cos(this.moveAngle) * this.speed;
        let y = this.y + Math.sin(this.moveAngle) * this.speed;
        if(x<=0) this.x = 0;
        else if(x+entitySize>=roomSize) this.x = roomSize-entitySize;
        else this.x = x;
        if(y<=0) this.y = 0;
        else if(y+entitySize>=roomSize) this.y = roomSize-entitySize;
        else this.y = y;
      }
      update(turn){
        //pathfinding
        let px = player.x - this.x; let py = player.y - this.y;
        let d = (px*px)+(py*py);
        if( d<=sightRangeSquared){//checking if entity is near the player
          let m = Math.atan(py/px);
          this.moveAngle = (px<0) ? ((py<0)?m+Math.PI:Math.PI+m) : ((py<0)?(2*Math.PI)+m:m);
          this.trackingPlayer = true;
          if(d<=attackRangeSquared){
            this.attackPlayer();
            return;//to give player space ig?
          }
        }
        else{//case; not near player
          //if(this.trackingPlayer===true){
            px = currentRoom.exitX - this.x - entitySize/2; py = currentRoom.exitY - this.y - entitySize/2;
            let m = Math.atan(py/px);
            this.moveAngle = (px<0) ? ((py<0)?m+Math.PI:Math.PI+m) : ((py<0)?(2*Math.PI)+m:m);
            this.trackingPlayer = false;
          //}
          //check if near exit of room
          if(this.contains(currentRoom.exitX, currentRoom.exitY)){ this.transferRooms();}
        }
        //movement
        this.move();
      }
      findRoomAtDirection(){
        let dir = (currentRoom.exitX!==roomSize/2) ? ((currentRoom.exitX===0)? "left" : "right") : ((currentRoom.exitY===0)? "down" : "up" );
        let r = currentRoom;
        switch(dir){
          case "left":
            r = getRoom(currentRoom.x-1, currentRoom.y);
            if(r===-1)break;
            console.log("going left");
            this.x = roomSize-entitySize-1; this.y = roomSize/2;
            break;
          case "right":
            r = getRoom(currentRoom.x+1, currentRoom.y);
            if(r===-1)break;
            console.log("going right");
            this.x = 1; this.y = roomSize/2;
            break;
          case "down":
            r = getRoom(currentRoom.x, currentRoom.y-1);
            if(r===-1)break;
            console.log("going down: "+currentRoom.x+","+currentRoom.y);
            this.x = roomSize/2; this.y = roomSize-entitySize-1;
            break;
          case "up":
            r = getRoom(currentRoom.x, currentRoom.y+1);
            if(r===-1)break;
console.log("going up");
            this.x = roomSize/2; this.y = 1;
            break;
        }
        return r;
      }
      transferRooms(){
        let r = this.findRoomAtDirection();
        if(r!==-1)currentRoom.entityTransfersTo(r, this);
      }
      contains(x, y){
        let m = 8;//margin of error
        if( (this.x-m<x && x<this.x+m+entitySize) && (this.y-m<y && y<this.y+m+entitySize) ) return true;
      }
      display(){
       // console.log("entity: "+this.hp+"/"+this.maxHP+" at ("+this.x+","+this.y+")");
        this.disp.style.left = this.x + "px";
        this.disp.style.bottom = this.y + "px";
      }
      initializeDisplay(){
        let en = document.createElement('div');
        en.classList.add("entity");
        en.style.width = entitySize + "px";
        en.style.height = entitySize + "px";
        en.style.left = this.x + "px";
        en.style.bottom = this.y + "px";
        document.getElementById(currentRoom.name).appendChild(en);
        this.disp = en;
      }
      attackPlayer(){
        
      }
    }
    class Player extends Entity{
      update(){
        //check if near exit of room
        let gap = 5;
        if(this.contains(0,roomSize/2)){
          if(this.transferRoomsTo(-1,0)===1)//left
          {this.x = roomSize-entitySize-gap; this.y = roomSize/2;}
        }
        else if(this.contains(roomSize,roomSize/2)){
          if(this.transferRoomsTo(1,0)===1)//right
          {this.x = gap; this.y = roomSize/2;}
        }
        else if(this.contains(roomSize/2,0)){
          if(this.transferRoomsTo(0,-1)===1)//down
          {this.x = roomSize/2; this.y = roomSize-entitySize-gap;}
        }
        else if(this.contains(roomSize/2,roomSize)){
          if(this.transferRoomsTo(0,1)===1)//up
          {this.x = roomSize/2; this.y = gap;}
        }
        //move
        this.move();
        //weapons
        updateEquippedWeapons();
      }
      transferRoomsTo(xAdd, yAdd){
        let r = getRoom(currentRoom.x+xAdd, currentRoom.y+yAdd);
        //let r = this.findRoomAtDirection();
        if(r!==-1){
          currentRoom.entityTransfersTo(r, this);
          currentRoom.leave();
          r.enter();
          return 1;
        }
        else return -1;
      }
      contains(x, y){
        let m = 2;//margin of error
        if( (this.x-m<x && x<this.x+m+entitySize) && (this.y-m<y && y<this.y+m+entitySize) ) return true;
      }
      initializeDisplay(){
        let en = document.createElement('div');
        en.classList.add("entity");
        en.style.width = entitySize + "px";
        en.style.height = entitySize + "px";
        en.style.left = this.x + "px";
        en.style.bottom = this.y + "px";
        en.style.backgroundColor = "red";
        document.getElementById(currentRoom.name).appendChild(en);
        this.disp = en;
      }
    }

  //UI BUTTON functions
    var pauseBtn, pauseDiv;
    var settingsBtn, quitBtn;
    function initializeOtherUIButtons(){
      //PAUSE BUTTON
      pauseBtn = document.createElement('button');
      pauseBtn.id = "pauseBtn";
      pauseBtn.style = "width: 62px; height: 62px; border-color: black; border-width: 4px; margin: 20px; border-radius: 10%; background-color: lightgreen; position: fixed; top: 0; right: 0; z-index: "+PAUSE_ZINDEX+";";
      document.getElementById("UI").appendChild(pauseBtn);
        //functions
      pauseBtn.addEventListener('touchstart', pause);
      pauseBtn.addEventListener('mousedown' , pause);
      //PAUSED DIV
      pauseDiv = document.createElement('div'); pauseDiv.id = "pauseDiv";
      pauseDiv.style = "width: 100%; height: 100%; background-color: black; opacity: 50%; z-index: "+(PAUSE_ZINDEX-1)+"; position: fixed; top: 0; left: 0; display: flex; justify-content: center; align-items: center;";
      pauseDiv.style.visibility = "hidden";
      document.getElementById('body').appendChild(pauseDiv);
        //within div
      settingsBtn = document.createElement('button'); settingsBtn.id = "settingsBtn";
      settingsBtn.innerText = "Settings";
      settingsBtn.addEventListener('click', function () {console.log('settings');
        moveBtnA.setWeapon(new Weapon(20,100,5,0.2,   1,10,1,   1,null,   20,   10,0.08));//test
})
      quitBtn = document.createElement('button'); quitBtn.id = "quitBtn";
      quitBtn.innerText = "Quit";
          //functions
          //adding
      pauseDiv.appendChild(settingsBtn);
      pauseDiv.appendChild(quitBtn);
    }
    
    function pause(){
      clearInterval(timer);
      //make all pause elements visible
      pauseDiv.style.visibility = "visible";
      //make pauseBtn to unpause
      pauseBtn.removeEventListener('touchstart', pause);
      pauseBtn.removeEventListener('mousedown' , pause);
      setTimeout(() => {
        pauseBtn.addEventListener('touchstart', unpause);
        pauseBtn.addEventListener('mousedown' , unpause);
      }, 1000);
    }
    function unpause(){
      //remove all elements visibility
      pauseDiv.style.visibility = "hidden";
      //re set pause btn
      pauseBtn.removeEventListener('touchstart', unpause);
      pauseBtn.removeEventListener('mousedown' , unpause);
      setTimeout(() => {
        pauseBtn.addEventListener('touchstart', pause);
      pauseBtn.addEventListener('mousedown' , pause);
      }, 1000);
      //timer start
      startTimer();
    }
  //MOVE BUTTON functions
    var moveBtnA, moveBtnB;
    function initializeMoveButtons(){
      moveBtnA = new MoveBtn(document.getElementById('moveBtnA'), "yellow");
      moveBtnB = new MoveBtn(document.getElementById('moveBtnB'), "blue");
      //moveBtnB.setWeapon(new Weapon(1,2,3,4,5,6,7,8,9));//test
    }
    class MoveBtn{
      constructor(buttonElement, color){
        this.htmlElement = buttonElement;
        this.htmlElement.addEventListener('touchstart', unequippedWeaponFunction);
        this.htmlElement.addEventListener('mousedown' , unequippedWeaponFunction);
        this.color = color;
        this.htmlElement.style.backgroundColor = color;

        this.weapon = null;
      }
      setWeapon(weapon){
        if(this.weapon!==null){
          this.weapon.unequip();
          this.htmlElement.removeEventListener('touchstart', executeWeaponFunction);
          this.htmlElement.removeEventListener('mousedown' , executeWeaponFunction);
        }
        else{
          this.htmlElement.removeEventListener('touchstart', unequippedWeaponFunction);
          this.htmlElement.removeEventListener('mousedown' , unequippedWeaponFunction);
        }
        this.weapon = weapon;
        this.htmlElement.addEventListener('touchstart', executeWeaponFunction);
        this.htmlElement.addEventListener('mousedown' , executeWeaponFunction);
      }
    }
    function executeWeaponFunction(event){
      const source = event.target || event.srcElement;
      let moveBtn = moveBtnB;
      if(source===moveBtnA.htmlElement) moveBtn = moveBtnA;
      moveBtn.weapon.executeWeaponFunction(player);
    }
    function updateEquippedWeapons(){
      let weapons = [moveBtnA.weapon, moveBtnB.weapon];
      for(let i = 0; i<weapons.length; i++){
        if(weapons[i]!==null) weapons[i].update();
      }
    }
    function unequippedWeaponFunction(){
      console.log("button has no equipped weapon");
    }
    function kob(){
      document.getElementById("body").style.backgroundColor = "blue";
    }
    function bok(){
      document.getElementById("body").style.backgroundColor = "yellow";
    }

    function btnAFunction(){
      document.getElementById("body").style.backgroundColor = "blue";
    }
    function btnBFunction(){
      document.getElementById("body").style.backgroundColor = "orange";
    }

  //JOYSTICK functions
    var joystick = document.getElementById('joystick'), joystickMovable;
    const INITIALRADIUS = 60, INITIALMARGIN = 40;
    var radius = INITIALRADIUS, posX = 0, posY = 0, spd = 0, angl = 0;
    var joystickClicked = false;

    function initializeJoystickAndFunctions(){
      //making joystick + css
      makeJoystick();
      joystick.style.margin = INITIALMARGIN+"px";
      
      //mouse controls
      joystick.addEventListener('mousedown', startJoystick);
      window.addEventListener('mouseup', stopJoystick);
      window.addEventListener('mouseleave', stopJoystick);
      window.addEventListener('mousemove', moveJoystick);
      //touch controls
      joystick.addEventListener('touchstart', startJoystick);
      joystick.addEventListener('touchend', stopJoystick);
      //joystick.addEventListener('touchcancel', stopJoystick);
      body.addEventListener('touchmove', moveJoystick);
      //TEST display buttons
      document.getElementById("x_coordinate").innerText = 0;
      document.getElementById("y_coordinate").innerText = 0;
      document.getElementById("speed").innerText = 0;
      document.getElementById("angle").innerText = 0;
    }
      //computing css changes
    function makeJoystick() {
      joystick.style.width = radius*2+"px";
      joystick.style.height = radius*2+"px";
      joystick.style.backgroundColor = "red";
    }
    function makeJoystickMovable() {
      joystickMovable.style.width = INITIALRADIUS*2+"px";
      joystickMovable.style.height = INITIALRADIUS*2+"px";
      joystickMovable.style.backgroundColor = "red";
      joystickMovable.style.position = "fixed";
    }
    function changeRadius(int){
      joystick.style.margin =  parseInt(window.getComputedStyle(joystick).margin, 10) - (int-radius) + "px";
      radius = int;
    }
      //computing changes to variables
    function updatePos(e){
      //pos
      if(e.type == 'touchstart' || e.type == 'touchmove' || e.type == 'touchend' || e.type == 'touchcancel'){
        posX = e.touches[0].clientX;
        posY = e.touches[0].clientY;
      } else if (e.type == 'mousedown' || e.type == 'mouseup' || e.type == 'mousemove' || e.type == 'mouseover'|| e.type=='mouseout' || e.type=='mouseenter' || e.type=='mouseleave') {
        posX = e.clientX;
        posY = e.clientY;
      }
      var marginVal = parseInt(window.getComputedStyle(joystick).margin, 10);
      posY = window.innerHeight - posY - radius - marginVal;
      posX -= marginVal + radius;
      //speed
      spd = Math.sqrt((posX*posX) + (posY*posY)) / radius;
      checkIfWithinRadius();
        //finalize spd
        spd = Math.round(spd*100)/100;
      //angle
      angl = Math.atan(posY/posX);
      /*if((Math.PI/4)>angl && angl>(-Math.PI/4)){ angl = 0;}
      else if(angl<0){ angl = -Math.PI/2;}
        else {angl = Math.PI/2;}*///use 4 cardinal directions
      
      angl = (posX<0) ? (Math.PI+angl) : ((posY<0)?(2*Math.PI)+angl:angl);
        //convert to degrees if u want
      //angl *= (180)/Math.PI;
      translateStats();
    }
    function checkIfWithinRadius(){
      if(spd>1){
        posX /= spd; posY /= spd;
        spd = 1;
      }
    }
    /*function isItWithinRadius() {
      var distance = (posX*posX) + (posY*posY);
      if ( distance < radius*radius ) return true;
      else return false;
    }*/
    //event functions
    function startJoystick(event) {
      //make movable part of joystick in html
      joystickMovable = document.createElement('div');
      makeJoystickMovable();
      joystick.appendChild(joystickMovable);
      //start the joystick
      joystickClicked = true;
      changeRadius(85);
      makeJoystick();
      joystick.style.backgroundColor = "lightgreen";
      //update
      moveJoystick(event);
    }
    function stopJoystick() {
      //delete movable part of joystick in html
      joystick.innerText = "";
      //stop the joystick
      joystickClicked = false;
      changeRadius(60);
      makeJoystick();
      joystick.style.backgroundColor = "red";
      //reset stats
      resetStats();
      displayStats();
      translateStats();
    }
    function moveJoystick(event) {
      if (joystickClicked){
        //update position
        updatePos(event);
        displayStats();
        //move joystickMovable
        moveJoystickMovable();
      }
    }
    //moving joystick movable
    function moveJoystickMovable(){
      var marginVal = parseInt(window.getComputedStyle(joystick).margin, 10);
      joystickMovable.style.left = marginVal + radius - INITIALRADIUS + posX + "px";
      joystickMovable.style.bottom = marginVal + radius - INITIALRADIUS + posY + "px";
    }
    //display functions
    function displayStats(){
      let uno = "Ek ", dos = "Wi ", tre = "Spe ", qua = "Ang ";
      x_coordinate.innerText = Math.floor(posX);
      y_coordinate.innerText = Math.floor(posY);
      speed.innerText = spd;
      angle.innerText = Math.floor(angl*100)/100;
      e1.innerText=" "+uno.substring(x_coordinate.innerText.length,4);
      e2.innerText=" "+dos.substring(y_coordinate.innerText.length,4);
      e3.innerText=" "+tre.substring(speed.innerText.length,5);
      e4.innerText=" "+qua.substring(angle.innerText.length,5);
    }
    function resetStats(){
      posX=0; posY=0; spd=0;
    }
    function translateStats(){
      player.speed = 4*spd; player.moveAngle = angl;
    }
  </script>

</html>